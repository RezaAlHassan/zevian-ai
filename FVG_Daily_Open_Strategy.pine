//@version=5
// Note: This script is compatible with both PineScript v5 and v6
// For PineScript v6, change the first line to: //@version=6

strategy("FVG Daily Open Strategy - 15m Timeframe", 
     overlay=true, 
     initial_capital=10000, 
     default_qty_type=strategy.percent_of_equity, 
     default_qty_value=10, 
     pyramiding=0,
     calc_on_every_tick=false,
     calc_on_order_fills=false)

// ============================================================================
// INPUTS
// ============================================================================
showFVGs = input.bool(true, title="Show FVG Boxes", group="Visual Settings")
bullFvgColor = input.color(color.new(color.green, 80), title="Bullish FVG Color", group="Visual Settings")
bearFvgColor = input.color(color.new(color.red, 80), title="Bearish FVG Color", group="Visual Settings")
atrPeriod = input.int(14, title="ATR Period for SL/TP", minval=1, group="Risk Management")
riskRewardRatio = input.float(2.0, title="Risk:Reward Ratio", minval=0.5, step=0.1, group="Risk Management")

// Backtest Period Settings
enableBacktestPeriod = input.bool(false, title="Enable Backtest Period Filter", group="Backtest Settings")
backtestStartDate = input.time(timestamp("2020-01-01 00:00 +0000"), title="Backtest Start Date", group="Backtest Settings")
backtestEndDate = input.time(timestamp("2024-12-31 23:59 +0000"), title="Backtest End Date", group="Backtest Settings")

// ============================================================================
// CONSTANTS
// ============================================================================
int TRADING_WINDOW_HOURS = 11
int BARS_PER_HOUR = 4  // 15-minute timeframe = 4 bars per hour
int MAX_WINDOW_BARS = TRADING_WINDOW_HOURS * BARS_PER_HOUR  // 44 bars

// ============================================================================
// BACKTEST PERIOD CHECK
// ============================================================================
bool inBacktestPeriod = true
if enableBacktestPeriod
    inBacktestPeriod := time >= backtestStartDate and time <= backtestEndDate
else
    inBacktestPeriod := true

// ============================================================================
// STATE VARIABLES (Reset Daily)
// ============================================================================
var bool tradeExecutedToday = false
var int currentBias = 0  // 1 = Bullish, -1 = Bearish, 0 = No bias
var bool priceHasTappedOpen = false
var bool waitingForEntry = false
var float entryReference = na

// ============================================================================
// DAILY RESET LOGIC
// ============================================================================
bool isNewDay = ta.change(time("D")) != 0
if isNewDay
    tradeExecutedToday := false
    currentBias := 0
    priceHasTappedOpen := false
    waitingForEntry := false
    entryReference := na

// ============================================================================
// TRADING WINDOW CALCULATION
// ============================================================================
int barsSinceOpen = bar_index - ta.valuewhen(isNewDay, bar_index, 0)
bool inTradingWindow = barsSinceOpen < MAX_WINDOW_BARS and barsSinceOpen >= 0

// ============================================================================
// DAILY OPEN REFERENCE POINT
// ============================================================================
float dailyOpen = request.security(syminfo.tickerid, "D", open, lookahead=barmerge.lookahead_on)

// ============================================================================
// FVG DETECTION (3-Candle Pattern)
// ============================================================================
// Bullish FVG: high[2] < low[0] (gap between candle 1 high and candle 3 low)
// Bearish FVG: low[2] > high[0] (gap between candle 1 low and candle 3 high)
bool bullishFVG = high[2] < low[0]
bool bearishFVG = low[2] > high[0]

// ============================================================================
// BIAS DETERMINATION (Most Recent FVG Wins)
// ============================================================================
// Update bias ONLY within trading window and ONLY if no trade executed yet
if inTradingWindow and not tradeExecutedToday and inBacktestPeriod
    if bullishFVG
        currentBias := 1
        priceHasTappedOpen := false  // Reset tap status when bias changes
        waitingForEntry := false
        
    if bearishFVG
        currentBias := -1
        priceHasTappedOpen := false  // Reset tap status when bias changes
        waitingForEntry := false

// ============================================================================
// PRICE TAP DETECTION
// ============================================================================
// Check if current candle touches the daily open
bool currentCandleTapsOpen = high >= dailyOpen and low <= dailyOpen

// Mark that price has tapped the open (only when we have a bias)
if inTradingWindow and currentBias != 0 and currentCandleTapsOpen and not priceHasTappedOpen and inBacktestPeriod
    priceHasTappedOpen := true
    waitingForEntry := true

// ============================================================================
// ENTRY BAR FVG REVERSAL CHECK
// ============================================================================
// If the candle that just closed (after tapping open) forms a counter-bias FVG,
// we flip the bias and wait for price to tap the open again
bool entryBarFormsCounterFVG = false
if waitingForEntry and currentBias != 0 and inBacktestPeriod
    // Check if current bar (which just closed) is the 3rd candle of a counter-bias FVG
    if currentBias == 1 and bearishFVG  // We were bullish, but bearish FVG formed
        currentBias := -1
        priceHasTappedOpen := false
        waitingForEntry := false
        entryBarFormsCounterFVG := true
        
    else if currentBias == -1 and bullishFVG  // We were bearish, but bullish FVG formed
        currentBias := 1
        priceHasTappedOpen := false
        waitingForEntry := false
        entryBarFormsCounterFVG := true

// ============================================================================
// ENTRY SIGNAL GENERATION
// ============================================================================
bool longSignal = false
bool shortSignal = false

// Enter ONLY after:
// 1. We are in trading window
// 2. We have a bias
// 3. Price has tapped the open
// 4. We are waiting for entry
// 5. No counter-bias FVG formed on this bar
// 6. No trade executed today yet
// 7. We are within backtest period (if enabled)
if inTradingWindow and waitingForEntry and not entryBarFormsCounterFVG and not tradeExecutedToday and inBacktestPeriod
    if currentBias == 1
        longSignal := true
    else if currentBias == -1
        shortSignal := true

// ============================================================================
// RISK MANAGEMENT CALCULATIONS
// ============================================================================
float atrValue = ta.atr(atrPeriod)[1]  // ATR of previous candle
float riskAmount = atrValue
float rewardAmount = riskAmount * riskRewardRatio

// ============================================================================
// TRADE EXECUTION
// ============================================================================
if longSignal and strategy.opentrades == 0 and inBacktestPeriod
    float entryPrice = close
    float stopLoss = entryPrice - riskAmount
    float takeProfit = entryPrice + rewardAmount
    
    strategy.entry("Long", strategy.long, comment="LONG Entry")
    strategy.exit("Exit Long", from_entry="Long", stop=stopLoss, limit=takeProfit)
    
    tradeExecutedToday := true
    waitingForEntry := false
    
    // Draw entry visualization
    label.new(bar_index, high, "LONG\nEntry: " + str.tostring(entryPrice, format.mintick) + 
         "\nSL: " + str.tostring(stopLoss, format.mintick) + 
         "\nTP: " + str.tostring(takeProfit, format.mintick), 
         style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

if shortSignal and strategy.opentrades == 0 and inBacktestPeriod
    float entryPrice = close
    float stopLoss = entryPrice + riskAmount
    float takeProfit = entryPrice - rewardAmount
    
    strategy.entry("Short", strategy.short, comment="SHORT Entry")
    strategy.exit("Exit Short", from_entry="Short", stop=stopLoss, limit=takeProfit)
    
    tradeExecutedToday := true
    waitingForEntry := false
    
    // Draw entry visualization
    label.new(bar_index, low, "SHORT\nEntry: " + str.tostring(entryPrice, format.mintick) + 
         "\nSL: " + str.tostring(stopLoss, format.mintick) + 
         "\nTP: " + str.tostring(takeProfit, format.mintick), 
         style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// ============================================================================
// FVG BOX VISUALIZATION
// ============================================================================
if inTradingWindow and showFVGs and inBacktestPeriod
    if bullishFVG
        box.new(bar_index[1], low[0], bar_index, high[2], 
             border_color=na, bgcolor=bullFvgColor)
    
    if bearishFVG
        box.new(bar_index[1], high[0], bar_index, low[2], 
             border_color=na, bgcolor=bearFvgColor)

// ============================================================================
// PLOTTING & VISUALIZATION
// ============================================================================
// Plot daily open as horizontal line (changes color based on window status)
plot(dailyOpen, title="Daily Open", 
     color=inTradingWindow and inBacktestPeriod ? color.new(color.blue, 0) : color.new(color.gray, 50), 
     linewidth=2, style=plot.style_linebr)

// Background shading for trading window
bgcolor(inTradingWindow and inBacktestPeriod ? color.new(color.blue, 95) : na, title="Trading Window")

// Bias indicator (dot at top of chart)
color biasColor = currentBias == 1 ? color.green : currentBias == -1 ? color.red : color.gray
plotchar(inTradingWindow and inBacktestPeriod ? true : na, title="Current Bias", char="â—", 
     location=location.top, color=biasColor, size=size.small)

// Status indicator at bottom
string statusText = not inBacktestPeriod ? "Outside Backtest Period" :
     tradeExecutedToday ? "Trade Done" : 
     waitingForEntry ? "Waiting Entry" : 
     priceHasTappedOpen ? "Open Tapped" : 
     currentBias != 0 ? "Has Bias" : 
     inTradingWindow ? "Scanning FVG" : "Outside Window"

var table statusTable = table.new(position.bottom_right, 2, 1, bgcolor=color.new(color.black, 80), border_width=1)
if barstate.islast
    table.cell(statusTable, 0, 0, "Status:", text_color=color.white, text_size=size.small)
    color statusColor = not inBacktestPeriod ? color.gray :
         tradeExecutedToday ? color.orange : 
         waitingForEntry ? color.yellow : 
         currentBias != 0 ? color.aqua : color.gray
    table.cell(statusTable, 1, 0, statusText, text_color=statusColor, text_size=size.small)

